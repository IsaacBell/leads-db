name: Daily updater

on:
  workflow_dispatch:
  schedule:
    - cron:  '*/45 * * * *'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: What time is it ?
      run: |
        date -u
        TZ="Europe/Paris" date
    
    - name: Set up Python 3
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install prerequisites
      run: |
        sudo apt -qq install fd-find

    - name: Prepare global variables
      run: | 
        echo "ZONES_DIR=$GITHUB_WORKSPACE/data/zones" >> $GITHUB_ENV
        echo "DAILY_DIR=$GITHUB_WORKSPACE/data/daily" >> $GITHUB_ENV
    
    - name: Sync data
      run: |    
        mkdir -p "$DAILY_DIR"
        wget -nv "https://raw.githubusercontent.com/maaaaz/dnsdumps/main/daily/today_new.gz" -O "$DAILY_DIR/today_new.gz"
        wget -nv "https://raw.githubusercontent.com/maaaaz/dnsdumps/main/daily/yesterday_new.gz" -O "$DAILY_DIR/yesterday_new.gz"
        
    - name: Git commit 
      run: |
        git config user.name IsaacBell
        git config user.email isaacbell388@gmail.com
        
        cd "$ZONES_DIR"
        git add ./*
        
        cd "$DAILY_DIR"
        git add "./today_new.gz" "./yesterday_new.gz" 
        
        git commit -a -m "updating bot - $(date '+%Y/%m/%d')"
        git pull
        git push
